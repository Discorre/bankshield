{"ast":null,"code":"// api.js\nimport axios from 'axios';\nconst API_URL = process.env.REACT_APP_API_URL;\nconst api = axios.create({\n  baseURL: `${API_URL}`\n});\n\n// Флаг, чтобы не запускать несколько обновлений одновременно\nlet isRefreshing = false;\nlet failedQueue = [];\nconst processQueue = (error, token = null) => {\n  failedQueue.forEach(prom => {\n    if (error) {\n      prom.reject(error);\n    } else {\n      prom.resolve(token);\n    }\n  });\n  failedQueue = [];\n};\n\n// Перехватчик ответа\napi.interceptors.response.use(res => res, async error => {\n  var _error$response;\n  const originalRequest = error.config;\n\n  // Если access_token истёк\n  if (((_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status) === 401 && !originalRequest._retry) {\n    originalRequest._retry = true;\n    if (isRefreshing) {\n      return new Promise(function (resolve, reject) {\n        failedQueue.push({\n          resolve,\n          reject\n        });\n      }).then(token => {\n        originalRequest.headers['Authorization'] = `Bearer ${token}`;\n        return axios(originalRequest);\n      }).catch(err => Promise.reject(err));\n    }\n    isRefreshing = true;\n    try {\n      const refreshToken = localStorage.getItem('adminRefreshToken');\n      const response = await axios.post(`${API_URL}/refresh`, {}, {\n        headers: {\n          'Authorization': refreshToken\n        }\n      });\n      const newAccessToken = response.data.access_token;\n      localStorage.setItem('adminAccessToken', newAccessToken);\n      api.defaults.headers.common['Authorization'] = `Bearer ${newAccessToken}`;\n      processQueue(null, newAccessToken);\n      originalRequest.headers['Authorization'] = `Bearer ${newAccessToken}`;\n      return api(originalRequest);\n    } catch (err) {\n      localStorage.removeItem('adminRefreshToken');\n      localStorage.removeItem('adminAccessToken');\n      localStorage.removeItem('adminUser');\n      window.location.href = '/login';\n      processQueue(err, null);\n      return Promise.reject(err);\n    } finally {\n      isRefreshing = false;\n    }\n  }\n  return Promise.reject(error);\n});\napi.interceptors.request.use(config => {\n  const token = localStorage.getItem('adminAccessToken');\n  if (token) {\n    config.headers['Authorization'] = `Bearer ${token}`;\n  }\n  return config;\n}, error => Promise.reject(error));\nexport default api;","map":{"version":3,"names":["axios","API_URL","process","env","REACT_APP_API_URL","api","create","baseURL","isRefreshing","failedQueue","processQueue","error","token","forEach","prom","reject","resolve","interceptors","response","use","res","_error$response","originalRequest","config","status","_retry","Promise","push","then","headers","catch","err","refreshToken","localStorage","getItem","post","newAccessToken","data","access_token","setItem","defaults","common","removeItem","window","location","href","request"],"sources":["C:/Users/egori/vscodeprojects/bankshield/bankshield-client/src/admin/api/api.js"],"sourcesContent":["// api.js\r\nimport axios from 'axios';\r\n\r\nconst API_URL = process.env.REACT_APP_API_URL;\r\n\r\nconst api = axios.create({\r\n  baseURL: `${API_URL}`,\r\n});\r\n\r\n// Флаг, чтобы не запускать несколько обновлений одновременно\r\nlet isRefreshing = false;\r\nlet failedQueue = [];\r\n\r\nconst processQueue = (error, token = null) => {\r\n  failedQueue.forEach(prom => {\r\n    if (error) {\r\n      prom.reject(error);\r\n    } else {\r\n      prom.resolve(token);\r\n    }\r\n  });\r\n  failedQueue = [];\r\n};\r\n\r\n// Перехватчик ответа\r\napi.interceptors.response.use(\r\n  res => res,\r\n  async error => {\r\n    const originalRequest = error.config;\r\n\r\n    // Если access_token истёк\r\n    if (error.response?.status === 401 && !originalRequest._retry) {\r\n      originalRequest._retry = true;\r\n\r\n      if (isRefreshing) {\r\n        return new Promise(function (resolve, reject) {\r\n          failedQueue.push({ resolve, reject });\r\n        }).then(token => {\r\n          originalRequest.headers['Authorization'] = `Bearer ${token}`;\r\n          return axios(originalRequest);\r\n        }).catch(err => Promise.reject(err));\r\n      }\r\n\r\n      isRefreshing = true;\r\n\r\n      try {\r\n        const refreshToken = localStorage.getItem('adminRefreshToken');\r\n        const response = await axios.post(`${API_URL}/refresh`, {}, {\r\n          headers: {\r\n            'Authorization': refreshToken,\r\n          },\r\n        });\r\n\r\n        const newAccessToken = response.data.access_token;\r\n        localStorage.setItem('adminAccessToken', newAccessToken);\r\n\r\n        api.defaults.headers.common['Authorization'] = `Bearer ${newAccessToken}`;\r\n        processQueue(null, newAccessToken);\r\n\r\n        originalRequest.headers['Authorization'] = `Bearer ${newAccessToken}`;\r\n        return api(originalRequest);\r\n      } catch (err) {\r\n        localStorage.removeItem('adminRefreshToken');\r\n        localStorage.removeItem('adminAccessToken');\r\n        localStorage.removeItem('adminUser');\r\n\r\n        window.location.href = '/login';\r\n\r\n        processQueue(err, null);\r\n        return Promise.reject(err);\r\n      } finally {\r\n        isRefreshing = false;\r\n      }\r\n    }\r\n\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n\r\napi.interceptors.request.use(\r\n  config => {\r\n    const token = localStorage.getItem('adminAccessToken');\r\n    if (token) {\r\n      config.headers['Authorization'] = `Bearer ${token}`;\r\n    }\r\n    return config;\r\n  },\r\n  error => Promise.reject(error)\r\n);\r\n\r\nexport default api;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}